{% load static %}
<style>
    #chatbot-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        font-family: system-ui, -apple-system, sans-serif;
    }

    #chatbot-toggle {
        background-color: #0056b3;
        color: white;
        border: 3px solid white;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
        padding: 0;
        overflow: hidden;
    }

    #chatbot-toggle:hover {
        transform: scale(1.05);
    }

    #chatbot-toggle svg {
        width: 100%;
        height: 100%;
    }

    #chatbot-window {
        display: none;
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e0e0e0;
    }

    #chatbot-header {
        background-color: #0056b3;
        color: white;
        padding: 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #chatbot-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 20px;
    }

    #chatbot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .message {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 15px;
        font-size: 14px;
        line-height: 1.4;
    }

    .message.bot {
        background-color: #e9ecef;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
    }

    .message.user {
        background-color: #0056b3;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
    }

    #chatbot-input-area {
        padding: 15px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        background: white;
    }

    #chatbot-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
    }

    #chatbot-input:focus {
        border-color: #0056b3;
    }

    #chatbot-send {
        background-color: #0056b3;
        color: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #chatbot-send:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
</style>

<div id="chatbot-widget">
    <button id="chatbot-toggle" aria-label="Ouvrir le chat">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="50" fill="#0056b3"/>
            <!-- Robot Head -->
            <rect x="25" y="30" width="50" height="45" rx="10" fill="#e0e0e0"/>
            <!-- Eyes -->
            <circle cx="40" cy="45" r="6" fill="white"/>
            <circle cx="40" cy="45" r="2" fill="#333"/>
            <circle cx="60" cy="45" r="6" fill="white"/>
            <circle cx="60" cy="45" r="2" fill="#333"/>
            <!-- Mouth -->
            <path d="M 35 60 Q 50 68 65 60" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>
            <!-- Antenna -->
            <line x1="50" y1="30" x2="50" y2="15" stroke="#e0e0e0" stroke-width="4"/>
            <circle cx="50" cy="15" r="5" fill="#ffcc00"/>
            <!-- Ears -->
            <rect x="18" y="45" width="7" height="15" rx="2" fill="#ccc"/>
            <rect x="75" y="45" width="7" height="15" rx="2" fill="#ccc"/>
        </svg>
    </button>

    <div id="chatbot-window">
        <div id="chatbot-header">
            <span>Assistant Dr Bronstein</span>
            <button id="chatbot-close">&times;</button>
        </div>
        <div id="chatbot-messages">
            <div class="message bot">
                Bonjour ! Je suis l'assistant virtuel. Posez-moi une question sur les examens, les horaires ou la préparation.
            </div>
        </div>
        <div id="chatbot-input-area">
            <input type="text" id="chatbot-input" placeholder="Posez votre question..." autocomplete="off">
            <button id="chatbot-send">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('chatbot-toggle');
        const window = document.getElementById('chatbot-window');
        const close = document.getElementById('chatbot-close');
        const input = document.getElementById('chatbot-input');
        const send = document.getElementById('chatbot-send');
        const messages = document.getElementById('chatbot-messages');

        function toggleChat() {
            if (window.style.display === 'flex') {
                window.style.display = 'none';
            } else {
                window.style.display = 'flex';
                input.focus();
            }
        }

        toggle.addEventListener('click', toggleChat);
        close.addEventListener('click', toggleChat);

        // Auto-open after 2 seconds
        setTimeout(() => {
            if (window.style.display !== 'flex') {
                toggleChat();
            }
        }, 2000);

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';
            input.disabled = true;
            send.disabled = true;

            try {
                const response = await fetch('/api/chatbot/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: text })
                });

                const data = await response.json();
                addMessage(data.response, 'bot');

                if (data.suggest_openevidence) {
                    const btn = document.createElement('button');
                    btn.textContent = "Voir une réponse complémentaire";
                    btn.style.cssText = "margin: 5px 15px; padding: 8px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;";
                    btn.onclick = () => requestOpenEvidence(text);
                    messages.appendChild(btn);
                    messages.scrollTop = messages.scrollHeight;
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage("Désolé, une erreur est survenue.", 'bot');
            } finally {
                input.disabled = false;
                send.disabled = false;
                input.focus();
            }
        }

        async function requestOpenEvidence(originalQuery) {
            addMessage("Recherche d'informations complémentaires...", 'bot');
            try {
                const response = await fetch('/api/chatbot/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: originalQuery, type: 'openevidence' })
                });
                const data = await response.json();
                addMessage(data.response, 'bot');
            } catch (error) {
                addMessage("Erreur lors de la connexion à OpenEvidence.", 'bot');
            }
        }

        send.addEventListener('click', sendMessage);
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });
</script>
